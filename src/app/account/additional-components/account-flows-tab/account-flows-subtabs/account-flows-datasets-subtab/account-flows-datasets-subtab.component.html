<div *ngIf="accountFlowsCardsData$ | async as cardsData">
    <div *ngIf="cardsData.nodes.length; else noCardsBlock">
        <div class="d-flex justify-content-end my-4 mb-2">
            <button
                (click)="refreshNow()"
                class="border-1 bg-light border rounded-2 px-2 btn btn-sm d-flex justify-content-between align-items-center"
            >
                <mat-icon class="text-muted fs-4 d-block">cached</mat-icon>
                <span class="fs-12 me-2 d-block"> Refresh now</span>
            </button>
        </div>
        <div class="d-flex justify-content-end mt-4 mb-2 fw-500">Total processes: {{ cardsData.totalCount }}</div>
        <div class="cards mt-4" data-test-id="cards">
            <ng-container *ngFor="let card of cardsData.nodes">
                <div *ngIf="card.__typename === 'DatasetFlowProcess'" class="card-custom d-flex flex-column">
                    <app-dataset-flow-process-card
                        [datasetBasics]="card.dataset"
                        [summary]="card.summary"
                        (updateNowEmitter)="updateNow($event)"
                        (toggleStateDatasetCardEmitter)="toggleStateDatasetCard($event)"
                    />
                </div>
                <div *ngIf="card.__typename === 'WebhookFlowSubProcess'" class="card-custom d-flex flex-column">
                    <div class="header" [ngClass]="badgeStyles(card.summary.effectiveState).containerClass"></div>
                    <div class="card-body my-2 p-4">
                        <span class="label label--secondary v-align-middle webhook">Webhook</span>
                        <div class="mt-3 mb-2 d-flex flex-row gap-3 align-items-center">
                            <div>
                                <mat-icon
                                    class="icon-size"
                                    [ngClass]="badgeStyles(card.summary.effectiveState).iconClass"
                                    >{{ badgeStyles(card.summary.effectiveState).iconName }}</mat-icon
                                >
                            </div>
                            <div class="d-flex flex-column">
                                <div class="dataset-list-container-title-row-dataset-name d-flex align-items-center">
                                    <a [routerLink]="['/']" class="dataset-list-container-title mb-1 pl-0">
                                        {{ card.name }}
                                    </a>
                                </div>

                                <div class="fw-500" [ngClass]="badgeStyles(card.summary.effectiveState).iconClass">
                                    {{ flowProcessEffectiveStateMapper(card.summary.effectiveState) }}
                                </div>
                            </div>
                        </div>
                        <div class="my-4 d-flex align-items-center justify-content-center">
                            <div class="d-flex flex-row gap-4">
                                <button
                                    type="button"
                                    (click)="
                                        toggleWebhookCardState(
                                            card.parentDataset!,
                                            card.id,
                                            card.summary.effectiveState
                                        )
                                    "
                                    class="badge-button border-1 bg-light border rounded-2 px-2 btn btn-sm"
                                >
                                    <mat-icon class="text-muted fs-4 d-block" svgIcon="play_pause" />
                                    <span class="fs-12 me-2 d-block">
                                        {{
                                            card.summary.effectiveState === FlowProcessEffectiveState.Active
                                                ? "Pause"
                                                : "Resume"
                                        }}
                                        webhook</span
                                    >
                                </button>
                                <button
                                    type="button"
                                    (click)="editWebhookCard(card.parentDataset!, card.id)"
                                    class="badge-button border-1 bg-light border rounded-2 px-2 btn btn-sm"
                                >
                                    <mat-icon class="text-muted fs-4 d-block">settings</mat-icon>
                                    <span class="fs-12 me-2 d-block link-settings">Edit webhook</span>
                                </button>
                            </div>
                        </div>
                        <div>
                            <div class="mt-2">
                                <span class="fw-500">Parent dataset:</span>
                                <a
                                    [routerLink]="[
                                        '/',
                                        card.parentDataset?.owner?.accountName,
                                        card.parentDataset?.name,
                                    ]"
                                    class="dataset-list-container-title mb-1 pl-0"
                                >
                                    {{ card.parentDataset?.owner?.accountName }}/{{ card.parentDataset?.name }}
                                </a>
                            </div>

                            <div class="mt-2">
                                <span class="text-muted fs-12" *ngIf="card.summary.lastSuccessAt"
                                    >Last success: {{ card.summary.lastSuccessAt | date: DISPLAY_TIME_FORMAT }}</span
                                >
                            </div>
                            <div>
                                <span class="text-muted fs-12" *ngIf="card.summary.lastFailureAt"
                                    >Last failure:: {{ card.summary.lastFailureAt | date: DISPLAY_TIME_FORMAT }}</span
                                >
                            </div>
                        </div>
                    </div>
                </div>
            </ng-container>
        </div>
        <div class="mt-50px">
            <app-pagination
                [currentPage]="cardsData.pageInfo.currentPage + 1"
                [pageInfo]="cardsData.pageInfo"
                (pageChangeEvent)="onPageChange($event)"
            ></app-pagination>
        </div>
    </div>
    <ng-template #noCardsBlock>
        <div class="mt-4" data-test-id="empty-cards-block">No cards belonging to this account</div>
    </ng-template>
</div>
