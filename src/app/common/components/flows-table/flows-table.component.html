<div class="mt-4 d-flex">
    <div class="w-250px">
        <angular2-multiselect
            [settings]="filterAccountSettings"
            [data]="dropdownAccountList"
            [(ngModel)]="selectedAccountItems"
        >
        </angular2-multiselect>
    </div>

    <div class="ms-4" *ngIf="hasDatasetColumn">
        <angular2-multiselect
            [settings]="FILTER_DATASET_SETTINGS"
            [data]="dropdownDatasetList"
            [(ngModel)]="selectedDatasetItems"
        >
        </angular2-multiselect>
    </div>

    <div class="ms-4">
        <angular2-multiselect
            [settings]="FILTER_STATUS_SETTINGS"
            [data]="dropdownStatustList"
            [(ngModel)]="selectedStatusItems"
        >
        </angular2-multiselect>
    </div>

    <div class="d-flex ms-4 align-items-center">
        <button
            type="button"
            [disabled]="!selectedDatasetItems.length && !selectedAccountItems.length && !selectedStatusItems.length"
            class="border-1 bg-light border search-creator-button rounded-2 ps-2 pe-4 btn btn-sm d-flex justify-content-between align-items-center"
            (click)="onSearch()"
        >
            <mat-icon class="fs-4 search-creator-icon d-block me-2">search</mat-icon>
            <span class="d-block">Search</span>
        </button>

        <a (click)="onResetFilters()" class="ms-4"> Reset filters </a>
    </div>
</div>

<div class="form-check my-3 d-flex gap-2">
    <input
        class="form-check-input"
        type="checkbox"
        (change)="onToggleSystemFlows()"
        [(ngModel)]="onlySystemFlows"
        [attr.data-test-id]="'only-system-flow'"
    />
    <label class="form-check-label"> Only system flows </label>
</div>

<table mat-table [dataSource]="dataSource">
    <!-- Description Column -->
    <ng-container matColumnDef="description">
        <th mat-header-cell *matHeaderCellDef>
            <span class="text-dark"> Status </span>
        </th>
        <td mat-cell *matCellDef="let element" style="height: 62px">
            <div class="d-flex py-1 ps-3">
                <mat-icon class="icon-status margin-top-5" [ngClass]="descriptionColumnOptions(element).class">{{
                    descriptionColumnOptions(element).icon
                }}</mat-icon>
                <div class="ms-1 py-2 position-relative">
                    <img
                        *ngIf="element.status !== FlowStatus.Finished"
                        [src]="dynamicImgSrc(element.status)"
                        class="dynamic-icon"
                    />
                    <a
                        (click)="navigateToFlowDetaisView(element, element.description.datasetId)"
                        class="fw-500 description-link text-dark"
                    >
                        {{ flowTypeDescription(element) }}
                        <span>{{ descriptionDatasetFlowEndOfMessage(element) }}</span>
                    </a>
                    <div
                        class="text-small d-block pe-4 truncate-sub-message"
                        [innerHTML]="
                            descriptionDatasetFlowSubMessage(element, element.description.datasetId) | safeHtml
                        "
                    ></div>
                </div>
            </div>
        </td>
    </ng-container>

    <!-- Information Column -->
    <ng-container matColumnDef="information">
        <th mat-header-cell *matHeaderCellDef style="width: 30%">
            <div class="text-dark mt-1 ps-4">Duration</div>
        </th>
        <td mat-cell *matCellDef="let element">
            <div class="d-flex flex-column py-1">
                <div class="d-flex align-items-center">
                    <mat-icon class="icon-status text-muted" [title]="tooltipText(element)">calendar_today</mat-icon>
                    <span class="ml-2px pt-1 text-small">
                        {{ durationBlockText(element) }}
                    </span>
                </div>
                <div class="d-flex align-items-center" *ngIf="durationBlockVisible(element)">
                    <svg-icon name="timer" class="ps-1 pe-2 text-muted" [title]="'duration'"></svg-icon>
                    <span class="text-small pt-1">
                        <span class="text-small">completed in </span>
                        {{ durationTask(element.timing.runningSince, element.timing.finishedAt) }}
                    </span>
                </div>
                <div class="d-flex align-items-center" *ngIf="waitingForBlockVisible(element)">
                    <svg-icon name="hour-glass" class="ps-1 pe-2 text-muted" [title]="'waiting condition'"></svg-icon>
                    <span class="text-small pt-1"> {{ waitingBlockText(element.startCondition) }} </span>
                </div>
            </div>
        </td>
    </ng-container>

    <!-- Creator Column -->
    <ng-container matColumnDef="creator">
        <th mat-header-cell *matHeaderCellDef style="width: 15%">
            <span class="text-dark"> Initiated By </span>
        </th>
        <td mat-cell *matCellDef="let element" style="height: 62px">
            <div class="d-flex align-items-center ps-3">
                <ng-container *ngIf="element.initiator; else noInitiator">
                    <img class="img-creator" [src]="element.initiator.avatarUrl ?? DEFAULT_AVATAR_URL" />
                    <span class="ms-2 text-small"> {{ element.initiator.displayName }}</span>
                </ng-container>
                <ng-template #noInitiator>
                    <span class="text-small">{{ DEFAULT_FLOW_INITIATOR }}</span>
                </ng-template>
            </div>
        </td>
    </ng-container>

    <ng-container matColumnDef="dataset" *ngIf="hasDatasetColumn">
        <th mat-header-cell *matHeaderCellDef>
            <div class="text-dark mt-1 ps-4">Dataset</div>
        </th>

        <td mat-cell *matCellDef="let element">
            <div class="d-flex align-items-center ps-3">
                <a (click)="onClickDataset(element.description.datasetId)" class="text-small">{{
                    datasetById(element.description.datasetId).name
                }}</a>
            </div>
        </td>
    </ng-container>

    <!-- Options Column -->
    <ng-container matColumnDef="options">
        <th mat-header-cell *matHeaderCellDef style="width: 20%"></th>
        <td mat-cell *matCellDef="let element">
            <div class="pe-2">
                <button mat-button [matMenuTriggerFor]="tableOptions"><svg-icon name="show-options"></svg-icon></button>
                <mat-menu #tableOptions="matMenu" xPosition="before" [hasBackdrop]="true">
                    <button mat-menu-item (click)="navigateToFlowDetaisView(element, element.description.datasetId)">
                        Details
                    </button>
                    <mat-divider></mat-divider>
                    <button
                        (click)="cancelFlow(element.flowId, element.description.datasetId)"
                        mat-menu-item
                        [disabled]="element.status === FlowStatus.Finished"
                    >
                        Cancel flow
                    </button>
                </mat-menu>
            </div>
        </td>
    </ng-container>

    <!-- Row shown when there is no matching data. -->
    <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell text-center" [attr.colspan]="tableOptions.displayColumns.length">
            No data matching the filter
        </td>
    </tr>

    <tr mat-header-row *matHeaderRowDef="tableOptions.displayColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: tableOptions.displayColumns"></tr>
</table>
