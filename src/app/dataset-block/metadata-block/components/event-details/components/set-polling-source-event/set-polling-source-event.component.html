<div class="d-flex justify-content-end">
    <span class="me-2">Show as yaml</span>
    <app-toggle
        [isToggled]="isYamlView"
        (toggled)="onToggleView($event)"
    ></app-toggle>
</div>

<div *ngIf="isYamlView" class="layout lh-1 font-monospace mt-4">
    <p class="color-key">fetch:</p>
    <p>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kind:
        <span class="value-color">
            {{ event.fetch.__typename }}
        </span>
    </p>
    <ng-container *ngIf="fetchStepUrl">
        <p>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url:
            <a [href]="fetchStepUrl.url" [title]="fetchStepUrl.url"
                ><span class="value-color lh-sm">{{
                    fetchStepUrl.url
                }}</span></a
            >
        </p>
        <p *ngIf="fetchStepUrl.eventTime">
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eventTime:
        </p>
    </ng-container>
    <ng-container *ngIf="isFetchStepFilesGlob">
        <p>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path:
            <span class="value-color">{{ fetchStepFilesGlob.path }}</span>
        </p>
    </ng-container>
    <p class="color-key">read:</p>
    <p>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kind:
        <span class="value-color">{{ event.read.__typename }}</span>
    </p>
    <ng-container *ngIf="isReadStepCsv">
        <p>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;separator:
            <span class="value-color"> "{{ readStepCsv.separator }}"</span>
        </p>
        <p>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;header:
            <span class="value-color"> {{ readStepCsv.header }}</span>
        </p>
    </ng-container>
    <p class="color-key">merge:</p>
    <ng-container *ngIf="isMergeStrategyLedger">
        <p>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kind:
            <span class="value-color"> {{ event.merge.__typename }}</span>
        </p>
        <p>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;primaryKey:
            <span class="value-color">
                {{ mergeStrategyLedger.primaryKey.join(", ") }}</span
            >
        </p>
    </ng-container>

    <ng-container *ngIf="event.preprocess">
        <p class="color-key">preprocess:</p>
        <p>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kind:
            <span class="value-color"> {{ event.preprocess.__typename }}</span>
        </p>

        <p>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;engine:
            <span class="value-color"> {{ event.preprocess.engine }}</span>
        </p>

        <p *ngIf="event.preprocess.version">
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;version:
            <span class="value-color"> {{ event.preprocess.version }}</span>
        </p>

        <ng-container *ngIf="event.preprocess.queries">
            <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;queries:</p>
            <ng-container *ngFor="let query of event.preprocess.queries">
                <p>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- alias:<span
                        class="value-color"
                    >
                        {{ query.alias ? query.alias : "none" }}</span
                    >
                </p>
                <p>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; query:<span
                        class="value-color lh-sm"
                    >
                        {{ query.query }}</span
                    >
                </p>
            </ng-container>
        </ng-container>
    </ng-container>
</div>

<ng-container *ngIf="!isYamlView">
    <div class="d-flex flex-column gap-4 mt-4">
        <div class="position-relative border border-1 p-2 rounded-3">
            <span
                class="position-absolute text-muted group-box-label text-uppercase"
                >Fetch</span
            >
            <div class="ms-4">
                <app-block-row-data
                    tooltip="URL of the data source."
                    label="Url:"
                >
                    <a
                        class="text-break"
                        [href]="fetchStepUrl.url"
                        [title]="fetchStepUrl.url"
                        >{{ fetchStepUrl.url }}</a
                    >
                </app-block-row-data>
            </div>
        </div>

        <div class="position-relative border border-1 p-2 rounded-3">
            <span
                class="position-absolute text-muted group-box-label text-uppercase"
                >Read</span
            >
            <div class="ms-4">
                <ng-container *ngIf="isReadStepCsv">
                    <app-block-row-data
                        tooltip="Sets a single character as a separator for each field and value."
                        label="Separator:"
                    >
                        <q class="fs-5">
                            <span class="fs-4">{{
                                readStepCsv.separator
                            }}</span>
                        </q>
                    </app-block-row-data>
                    <app-block-row-data
                        tooltip="Use the first line as names of columns."
                        label="Header:"
                    >
                        <span>{{ readStepCsv.header }}</span>
                    </app-block-row-data>
                </ng-container>
            </div>
        </div>

        <div class="position-relative border border-1 p-2 rounded-3">
            <span
                class="position-absolute text-muted group-box-label text-uppercase"
                >Merge</span
            >
            <div class="ms-4">
                <ng-container *ngIf="isMergeStrategyLedger">
                    <app-block-row-data
                        tooltip="Merge strategy determines how newly ingested data should be combined with the data that already exists in the dataset."
                        label="Strategy:"
                    >
                        <span>{{
                            descriptionMergeStrategy(event.merge.__typename)
                        }}</span>
                    </app-block-row-data>
                    <app-block-row-data
                        tooltip="Names of the columns that uniquely identify the record throughout its lifetime."
                        label="Primary key:"
                    >
                        <span class="font-monospace">{{
                            mergeStrategyLedger.primaryKey.join(", ")
                        }}</span>
                    </app-block-row-data>
                </ng-container>
            </div>
        </div>

        <div
            class="position-relative border border-1 p-2 rounded-3"
            *ngIf="event.preprocess"
        >
            <span
                class="position-absolute text-muted group-box-label text-uppercase"
                >Preprocess</span
            >
            <div class="ms-4">
                <app-block-row-data
                    tooltip="Identifier of the engine used for this transformation."
                    label="Engine:"
                    ><div class="d-flex align-items-end">
                        <img
                            class="engine-logo me-3"
                            [src]="
                                descriptionEngine(event.preprocess.engine)
                                    .url_logo
                            "
                            [alt]="event.preprocess.engine"
                        />
                        <span
                            >({{
                                descriptionEngine(event.preprocess.engine).name
                            }})</span
                        >
                    </div>
                </app-block-row-data>
                <app-block-row-data
                    tooltip="Queries use for specifying multi-step SQL transformations."
                    label="Queries:"
                    *ngIf="event.preprocess.queries"
                >
                </app-block-row-data>
                <ng-container
                    *ngFor="
                        let query of event.preprocess.queries;
                        let i = index
                    "
                >
                    <p *ngIf="query.alias">Alias: {{ query.alias }}</p>
                    <ngx-monaco-editor
                        [options]="sqlEditorOptions"
                        [(ngModel)]="query.query"
                    ></ngx-monaco-editor>
                    <mat-divider class="mb-2" *ngIf="i > 0"></mat-divider>
                </ng-container>
            </div>
        </div>
    </div>
</ng-container>
