<div class="d-flex p-4">
    <div class="flex-grow-1 ms-2">
        <span class="fs-5 fw-bold">{{
            subscriptionData ? "Webhook subscription details" : "Create subscription"
        }}</span>
    </div>
    <div>
        <button
            type="button"
            class="btn-close"
            aria-label="Close"
            (keydown.esc)="activeModal.close()"
            (click)="activeModal.close({ action: WebhookSubscriptionModalAction.CLOSE })"
        ></button>
    </div>
</div>
<div class="px-4">
    <mat-divider />
</div>

<div class="body p-4">
    <form [formGroup]="createSubscriptionForm">
        <div class="d-flex flex-column">
            <label for="" class="form-label">Target URL <span class="text-danger">*</span></label>
            <input
                type="text"
                data-test-id="target-url"
                formControlName="targetUrl"
                class="w-100 form-control"
                #targetUrl
            />
            <div
                class="text-danger fs-12"
                [input]="targetUrl"
                [fieldLabel]="'Target URL'"
                [appFieldError]="ErrorSets.TargetUrl"
                [group]="createSubscriptionForm"
            ></div>

            <p class="text-muted fs-12">
                Must be publicly reachable via HTTPS. Localhost and private Ips are not allowed
            </p>
        </div>
        <div class="d-flex flex-column">
            <label for="" class="form-label">Subscribed events <span class="text-danger">*</span></label>
            <ng-select
                [items]="dropdownList"
                bindLabel="name"
                bindValue="value"
                formControlName="eventTypes"
                [multiple]="true"
            >
                <ng-template ng-option-tmp let-item="item" let-index="index">
                    <label class="fs-14 inline-block"> {{ item.name }} </label>
                </ng-template>
            </ng-select>

            <div *ngIf="eventTypesControl?.invalid && (eventTypesControl?.touched || eventTypesControl?.dirty)">
                <div *ngIf="eventTypesControl?.errors?.required">
                    <span class="text-danger fs-12" data-test-id="error-event-selection">
                        Event selection is required</span
                    >
                </div>
            </div>
        </div>
        <div class="d-flex flex-column mt-4">
            <label for="" class="form-label">Label </label>
            <input type="text" data-test-id="target-url" formControlName="label" class="w-100 form-control" />
            <p class="text-muted fs-12">Optinal unique label to identify this webhook subscription</p>
        </div>
    </form>

    <ng-container *ngIf="subscriptionData">
        <div class="d-flex flex-column" *ngIf="subscriptionData.secret">
            <label for="" class="form-label">Secret </label>
            <div class="d-flex flex-row">
                <input
                    type="text"
                    data-test-id="subscription-secret-created"
                    [title]="secret"
                    [(ngModel)]="secret"
                    class="form-control w-100"
                    readonly
                />

                <button
                    (click)="copyToClipboard($event, subscriptionData.secret)"
                    data-test-id="copyToClipboard-secret"
                    aria-label="Copy to clipboard"
                    class="copy-button-data-access ms-1"
                    tabindex="0"
                    role="button"
                >
                    <div style="position: relative; display: inline-block">
                        <mat-icon class="mat-icon-svg-size" svgIcon="copy" />
                    </div>
                    <div style="position: relative; display: none">
                        <mat-icon class="mat-icon-svg-size" svgIcon="checked" />
                    </div>
                </button>
            </div>
            <p class="text-muted fs-12" role="alert">
                Make sure to copy your secret now. You wonâ€™t be able to see it again!
            </p>
        </div>
    </ng-container>
</div>

<div class="px-4 pt-4 pb-2 d-flex" *ngIf="!subscriptionData?.secret">
    <button
        type="button"
        (click)="activeModal.close()"
        class="btn btn-light flex-fill me-2"
        data-test-id="cancel-subscription"
    >
        Cancel
    </button>
    <button
        type="button"
        (click)="subscriptionData ? updateWebhook() : createWebhook()"
        [disabled]="createSubscriptionForm.invalid"
        class="btn btn-success flex-fill"
        [attr.data-test-id]="subscriptionData ? 'update-subscription' : 'create-subscription'"
    >
        {{ subscriptionData ? "Update" : "Create" }}
    </button>
</div>
<div class="d-flex px-4 pb-4" appFeatureFlag="dataset.panel.settings.webhooks.verifyNow">
    <button
        *ngIf="
            subscriptionData?.secret ||
            (subscriptionData && subscriptionData.status === WebhookSubscriptionStatus.Unverified)
        "
        [disabled]="true"
        type="button"
        (click)="verifyNow()"
        class="btn btn-primary flex-fill"
        data-test-id="subscription-verify-btn"
    >
        Verify now
    </button>
</div>
