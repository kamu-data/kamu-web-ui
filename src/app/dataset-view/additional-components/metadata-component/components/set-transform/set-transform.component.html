<div class="mb-4" *ngIf="queries">
    <div class="text-center mt-4">
        <p class="fs-4">Set Transformation</p>
        <p class="text-muted">
            Defines a transformation that produces data in a derivative dataset.
        </p>
    </div>
    <div class="container-layout mt-4" id="container-layout">
        <div class="row">
            <div class="col-lg-6 left-section">
                <div class="mb-3">
                    <mat-icon class="fs-4 align-middle">input</mat-icon>
                    <label for="inputDatasets" class="form-label ps-1">
                        Input datasets</label
                    >
                    <div class="d-flex flex-row align-items-center">
                        <input
                            type="text"
                            class="form-control w-425"
                            #searchDatasets
                            placeholder="Look up a dataset..."
                            [(ngModel)]="searchDataset"
                            [ngbTypeahead]="search"
                            [resultTemplate]="rt"
                            [inputFormatter]="formatter"
                            (selectItem)="onSelectItem($event)"
                        />
                        <button
                            (click)="clearSearch()"
                            mat-stroked-button
                            class="ms-2 button-custom bg-secondary text-white"
                        >
                            Clear
                        </button>
                    </div>
                </div>
                <ng-template #rt let-r="result" let-t="term">
                    <div
                        class="d-flex flex-row justify-content-between"
                        [style.width.px]="searchDatasets.clientWidth - 28"
                    >
                        <div>
                            <i class="bi bi-journal-album mr-2"></i>
                            <ngb-highlight
                                [result]="r.dataset.name"
                                [term]="t"
                            ></ngb-highlight>
                        </div>
                        <div
                            class="border rounded-1 flex-shrink-0 color-bg-tertiary px-1 f6 button-add color-text-tertiary ml-1"
                        >
                            Add
                            <span class="d-inline-block ml-1 v-align-middle"
                                ><i class="bi bi-arrow-return-left"></i
                            ></span>
                        </div>
                    </div>
                </ng-template>
                <div class="mt-4">
                    <mat-tree
                        [dataSource]="dataSource"
                        [treeControl]="treeControl"
                        class="tree"
                    >
                        <mat-tree-node
                            *matTreeNodeDef="let node"
                            matTreeNodeToggle
                        >
                            {{ node.name }}&nbsp;&nbsp; (
                            <span class="fw-bold">{{ node.type }}</span> )
                        </mat-tree-node>
                        <mat-nested-tree-node
                            *matTreeNodeDef="let node; when: hasChild"
                        >
                            <div class="mat-tree-node">
                                <button
                                    mat-icon-button
                                    matTreeNodeToggle
                                    [attr.aria-label]="'Toggle ' + node.name"
                                >
                                    <mat-icon class="mat-icon-rtl-mirror">
                                        {{
                                            treeControl.isExpanded(node)
                                                ? "expand_more"
                                                : "chevron_right"
                                        }}
                                    </mat-icon>
                                </button>
                                <span class="node-name"> {{ node.name }}</span>
                                <button
                                    class="no-button"
                                    (click)="deleteInputDataset(node.name)"
                                    title="Delete input dataset"
                                >
                                    <mat-icon class="fs-4 hover"
                                        >delete</mat-icon
                                    >
                                </button>
                            </div>

                            <div
                                [class.example-tree-invisible]="
                                    !treeControl.isExpanded(node)
                                "
                                role="group"
                            >
                                <ng-container matTreeNodeOutlet></ng-container>
                            </div>
                        </mat-nested-tree-node>
                    </mat-tree>
                </div>
                <div class="mt-4" *ngIf="knownEngines">
                    <p class="fs-6">Engine</p>
                    <mat-divider class="w-425"></mat-divider>
                    <div class="mt-4">
                        <label for="engine-type" class="form-label">Type</label>
                        <select
                            class="form-select w-425"
                            id="engine-type"
                            [(ngModel)]="selectedEngine"
                            (change)="onSelectType()"
                        >
                            <option
                                *ngFor="let engine of knownEngines"
                                [value]="engine.name.toUpperCase()"
                            >
                                {{ engine.name }}
                            </option>
                        </select>
                    </div>
                    <div class="mt-4">
                        <label for="engine-image" class="form-label"
                            >Image</label
                        >
                        <input
                            class="form-control w-425"
                            id="engine-image"
                            [(ngModel)]="selectedImage"
                            [title]="selectedImage"
                            disabled
                        />
                    </div>
                </div>
            </div>
            <div class="col-lg-6 queries">
                <mat-icon class="fs-4 align-middle">query_stats</mat-icon>
                <label for="inputDatasets" class="form-label ps-1">
                    Queries</label
                >
                <div
                    class="block-query mb-3"
                    *ngFor="let query of queries; let i = index"
                >
                    <div>
                        <div
                            class="d-flex flex-row justify-content-between align-items-end"
                        >
                            <div>
                                <label for="alias-query" class="form-label"
                                    >Alias</label
                                >
                                <div class="d-flex align-items-center">
                                    <input
                                        class="form-control w-425"
                                        id="alias-query"
                                        [(ngModel)]="queries[i].alias"
                                        [disabled]="isLastQuery(i)"
                                    />
                                    <span
                                        *ngIf="isLastQuery(i)"
                                        class="ms-4 badge bg-success"
                                        >output</span
                                    >
                                </div>
                            </div>
                            <div *ngIf="!isLastQuery(i)">
                                <button
                                    class="no-button"
                                    [disabled]="isPenultimateQuery(i)"
                                    (click)="swap(i, 1)"
                                    title="Move down"
                                >
                                    <mat-icon class="fs-4 hover"
                                        >expand_more</mat-icon
                                    >
                                </button>
                                <button
                                    class="no-button"
                                    (click)="swap(i, -1)"
                                    title="Move up"
                                >
                                    <mat-icon class="fs-4 mx-2 hover"
                                        >expand_less</mat-icon
                                    >
                                </button>
                                <button
                                    class="no-button"
                                    (click)="deleteQuery(i)"
                                    title="Delete query"
                                >
                                    <mat-icon class="fs-4 hover"
                                        >delete</mat-icon
                                    >
                                </button>
                            </div>
                        </div>
                        <div class="border border-1 mt-4 px-2 py-4">
                            <ngx-monaco-editor
                                style="height: 300px"
                                [options]="sqlEditorOptions"
                                [(ngModel)]="queries[i].query"
                                ngDefaultControl
                                data-test-id="monaco-editor-modal"
                            ></ngx-monaco-editor>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    <button
                        (click)="addQuery()"
                        mat-stroked-button
                        class="button-custom bg-secondary text-white"
                    >
                        Add query
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="d-flex justify-content-end section-buttons">
        <button
            type="button"
            mat-stroked-button
            class="button-custom width-custom bg-primary text-white"
            (click)="onEditYaml()"
            data-test-id="edit-yaml-set-transform-button"
        >
            Edit Yaml
        </button>
        <button
            type="button"
            mat-stroked-button
            class="button-custom ms-4 bg-success text-white width-custom"
            (click)="onSaveEvent()"
            data-test-id="save-set-transform-button"
        >
            Save
        </button>
    </div>
</div>
